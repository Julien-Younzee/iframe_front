{% comment %}
================================================================================
YOUNZEE VIRTUAL TRY-ON - INT√âGRATION SHOPIFY
================================================================================

Instructions d'installation:
1. Copiez ce code dans un nouveau snippet: snippets/younzee-vto.liquid
2. Incluez le snippet dans votre theme.liquid avant </body>:
   {% render 'younzee-vto' %}
3. Configurez les variables ci-dessous avec vos URLs

================================================================================
{% endcomment %}

{% comment %} CONFIGURATION {% endcomment %}
{% assign younzee_iframe_url = "https://votre-domaine-younzee.netlify.app" %}
{% assign younzee_enabled_on_product_page = true %}

{% if template contains 'product' and younzee_enabled_on_product_page %}

<!-- Styles pour le bouton et l'iframe -->
<style>
  /* Styles personnalis√©s uniquement pour les ajustements sp√©cifiques */
  .younzee-cta-button {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    margin: 12px 0;
    background: #ffde59 !important;
    color: #000000 !important;
    border-color: #ffde59 !important;
  }

  .younzee-cta-button:hover {
    background: #e6c850 !important;
    border-color: #e6c850 !important;
    color: #000000 !important;
  }

  .younzee-cta-button svg {
    flex-shrink: 0;
  }

  /* Container iframe - prend toute la page */
  .younzee-iframe-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 99999;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .younzee-iframe-container.active {
    pointer-events: auto;
    opacity: 1;
  }

  .younzee-iframe-container iframe {
    width: 100%;
    height: 100%;
    border: none;
  }

  /* Badge "Powered by Younzee" (optionnel) */
  .younzee-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    color: #666;
    margin-top: 8px;
  }

  .younzee-badge strong {
    color: #000;
  }
</style>

<!-- Bouton CTA sur la page produit -->
<div class="younzee-cta-wrapper">
  <button
    id="younzee-open-button"
    class="younzee-cta-button button button--full-width button--secondary"
    type="button"
    aria-label="Essayer virtuellement avec Younzee"
  >
    <svg fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="width: 20px; height: 20px; margin-right: 8px;">
      <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/>
    </svg>
    Essayer virtuellement
  </button>

  <div class="younzee-badge">
    powered by <strong>Younzee</strong>
  </div>
</div>

<!-- Container de l'iframe (cach√© par d√©faut) -->
<div id="younzee-iframe-container" class="younzee-iframe-container">
  <iframe
    id="younzee-iframe"
    src="{{ younzee_iframe_url }}"
    allow="camera"
    title="Younzee Virtual Try-On"
    loading="lazy"
  ></iframe>
</div>

<!-- Script de communication avec l'iframe -->
<script>
(function() {
  'use strict';

  // Configuration
  const YOUNZEE_IFRAME_ORIGIN = '{{ younzee_iframe_url }}';
  const iframeContainer = document.getElementById('younzee-iframe-container');
  const iframe = document.getElementById('younzee-iframe');
  const openButton = document.getElementById('younzee-open-button');

  // Donn√©es du produit Shopify actuel
  function getCurrentProductData() {
    {% if product %}
    {% comment %}
    D√©tection "Taille unique" :
    - Un produit est consid√©r√© comme "taille unique" si :
      1. Il n'a qu'une seule variante (has_only_default_variant)
      2. OU s'il n'a pas d'option "Size"/"Taille" dans ses variantes
      3. OU si toutes ses variantes ont la m√™me taille (ex: "TU", "Taille unique", "One Size")
    {% endcomment %}
    {% assign is_one_size = false %}
    {% assign one_size_keywords = 'taille unique,tu,one size,os,unique,u' | split: ',' %}

    {% comment %} Cas 1: Produit sans variantes (has_only_default_variant) {% endcomment %}
    {% if product.has_only_default_variant %}
      {% assign is_one_size = true %}
    {% else %}
      {% comment %} Cas 2: V√©rifier si l'option "Size" existe {% endcomment %}
      {% assign has_size_option = false %}
      {% for option in product.options %}
        {% assign option_lower = option | downcase %}
        {% if option_lower == 'size' or option_lower == 'taille' %}
          {% assign has_size_option = true %}
          {% assign size_option_index = forloop.index0 %}
        {% endif %}
      {% endfor %}

      {% if has_size_option == false %}
        {% comment %} Pas d'option taille = taille unique {% endcomment %}
        {% assign is_one_size = true %}
      {% else %}
        {% comment %} Cas 3: V√©rifier si toutes les tailles sont des mots-cl√©s "taille unique" {% endcomment %}
        {% assign all_sizes_are_one_size = true %}
        {% for variant in product.variants %}
          {% assign variant_size = variant.options[size_option_index] | downcase | strip %}
          {% assign size_is_one_size = false %}
          {% for keyword in one_size_keywords %}
            {% assign keyword_clean = keyword | strip %}
            {% if variant_size == keyword_clean %}
              {% assign size_is_one_size = true %}
              {% break %}
            {% endif %}
          {% endfor %}
          {% unless size_is_one_size %}
            {% assign all_sizes_are_one_size = false %}
            {% break %}
          {% endunless %}
        {% endfor %}
        {% if all_sizes_are_one_size %}
          {% assign is_one_size = true %}
        {% endif %}
      {% endif %}
    {% endif %}

    return {
      id: '{{ product.id }}',
      handle: '{{ product.handle }}',
      title: '{{ product.title | escape }}',
      vendor: '{{ product.vendor | escape }}',
      type: '{{ product.type | escape }}',

      // Image principale du produit
      imageUrl: '{{ product.featured_image | img_url: "1024x1024" }}',

      // Variante s√©lectionn√©e
      variant: {
        id: '{{ product.selected_or_first_available_variant.id }}',
        title: '{{ product.selected_or_first_available_variant.title | escape }}',
        price: '{{ product.selected_or_first_available_variant.price | money_without_currency }}',
        available: {{ product.selected_or_first_available_variant.available | json }},
      },

      // Taille unique : true si le produit n'a pas de variantes de taille
      isOneSize: {{ is_one_size | json }},

      // M√©tadonn√©es utiles
      tags: {{ product.tags | json }},
    };
    {% else %}
    return null;
    {% endif %}
  }

  // Ouvrir l'iframe
  function openYounzee() {
    iframeContainer.classList.add('active');
    document.body.style.overflow = 'hidden'; // Emp√™cher le scroll de la page

    // Envoyer un message pour ouvrir la popup dans l'iframe
    iframe.contentWindow.postMessage({
      type: 'OPEN_YOUNZEE'
    }, YOUNZEE_IFRAME_ORIGIN);
  }

  // Fermer l'iframe
  function closeYounzee() {
    iframeContainer.classList.remove('active');
    document.body.style.overflow = ''; // R√©activer le scroll
  }

  // √âcouter les clics sur le bouton
  if (openButton) {
    openButton.addEventListener('click', function() {
      console.log('üéØ Ouverture de Younzee VTO');
      openYounzee();
    });
  }

  // √âcouter les messages de l'iframe
  window.addEventListener('message', function(event) {
    // V√©rifier l'origine en production
    if (event.origin !== YOUNZEE_IFRAME_ORIGIN) {
      return;
    }

    console.log('üì© Message re√ßu de Younzee:', event.data.type);

    // L'iframe demande les informations du produit
    if (event.data.type === 'REQUEST_CLOTHING_ITEM') {
      const productData = getCurrentProductData();

      if (productData) {
        iframe.contentWindow.postMessage({
          type: 'CLOTHING_ITEM_DATA',
          item: productData
        }, YOUNZEE_IFRAME_ORIGIN);

        console.log('‚úÖ Donn√©es produit envoy√©es √† Younzee');
      }
    }

    // L'utilisateur veut ajouter au panier avec la taille recommand√©e
    if (event.data.type === 'ADD_TO_CART') {
      const { size, fitType } = event.data;

      console.log('üõí Ajout au panier:', { size, fitType });

      // Ajouter au panier Shopify
      addToShopifyCart(size, fitType);
    }

    // L'iframe a √©t√© ferm√©e
    if (event.data.type === 'YOUNZEE_CLOSED') {
      console.log('‚ùå Younzee ferm√©');
      closeYounzee();
    }
  });

  // Fonction pour ajouter au panier Shopify
  function addToShopifyCart(size, fitType) {
    {% if product %}

    // Trouver la variante correspondant √† la taille recommand√©e
    const variants = {{ product.variants | json }};

    // Chercher la variante avec la bonne taille
    let variantToAdd = variants.find(v => {
      const title = v.title.toLowerCase();
      return title.includes(size.toLowerCase());
    });

    // Si aucune variante trouv√©e, utiliser la variante s√©lectionn√©e
    if (!variantToAdd) {
      variantToAdd = variants.find(v => v.id === {{ product.selected_or_first_available_variant.id }});
    }

    if (!variantToAdd || !variantToAdd.available) {
      alert('D√©sol√©, cette taille n\'est pas disponible.');
      return;
    }

    // Ajouter au panier via l'API Shopify
    fetch('/cart/add.js', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        id: variantToAdd.id,
        quantity: 1,
        properties: {
          'Taille recommand√©e': size,
          'Type de coupe': fitType === 'fit' ? 'Pr√®s du corps' :
                          fitType === 'ideal' ? 'Ajust√©e' : 'Oversize',
          '_Younzee VTO': 'Oui'
        }
      })
    })
    .then(response => response.json())
    .then(data => {
      console.log('‚úÖ Produit ajout√© au panier:', data);

      // Fermer l'iframe
      closeYounzee();

      // Afficher une notification ou rediriger vers le panier
      if (window.theme && window.theme.cart && window.theme.cart.openCart) {
        // Si votre th√®me a une fonction pour ouvrir le cart drawer
        window.theme.cart.openCart();
      } else {
        // Sinon, afficher une alerte simple
        alert('‚úÖ Produit ajout√© au panier avec la taille ' + size + ' (' + fitType + ')');

        // Optionnel: rediriger vers le panier
        // window.location.href = '/cart';
      }

      // D√©clencher l'√©v√©nement Shopify pour mettre √† jour le compteur du panier
      document.dispatchEvent(new CustomEvent('cart:updated'));
    })
    .catch(error => {
      console.error('‚ùå Erreur ajout panier:', error);
      alert('Une erreur est survenue. Veuillez r√©essayer.');
    });

    {% endif %}
  }

  // Pr√©charger l'iframe au survol du bouton (optionnel, am√©liore la performance)
  if (openButton) {
    openButton.addEventListener('mouseenter', function() {
      if (!iframe.src) {
        iframe.src = YOUNZEE_IFRAME_ORIGIN;
      }
    }, { once: true });
  }
})();
</script>

{% endif %}
